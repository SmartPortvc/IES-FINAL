import{u as re,j as r,h as U,k as Q,q as le,L as ne,C as ie}from"./index-DYPp-ivU.js";import{r as n}from"./vendor-BOKTEpvH.js";import{D as ce}from"./DashboardLayout-CKQImzu3.js";import{D as ue}from"./DateRangePicker-D0mmnk8J.js";import{V as de}from"./VesselList-Bq5PBOp2.js";import{E as fe}from"./ErrorDisplay-CLSu7BDk.js";import{V as me}from"./ViewReportModal-Dk7h4j2a.js";import{E as pe,g as _}from"./excelReportGenerator-Dec86p7h.js";import{S as ge,C as De}from"./ui-WwCSzw8y.js";import"./SearchFilter-Ce2dtUoQ.js";import"./StatusBadge-dur_AQpe.js";import"./formatters-CaoZFZze.js";import"./excelExport-Be0WQBzE.js";const Oe=()=>{const{userRole:he}=re(),[x,we]=n.useState("vessels"),[y,V]=n.useState([]),[v,L]=n.useState([]),[P,B]=n.useState(!0),[S,W]=n.useState(null),[g,T]=n.useState("all"),[m,E]=n.useState(""),[p,A]=n.useState(""),[z,ye]=n.useState(null),[J,K]=n.useState(!1),[F,X]=n.useState([]),[ke,R]=n.useState(!0),[ve,O]=n.useState(null),[C,xe]=n.useState("all"),[b,be]=n.useState(""),[j,je]=n.useState("");n.useEffect(()=>{(async()=>{try{B(!0),W(null);const e=await U();if(V(e),g&&g!=="all"){const t=await Q(g);L(t)}else{const t=[];for(const o of e)if(o.id){const D=(await Q(o.id)).map(w=>({...w,portName:o.portName}));t.push(...D)}L(t)}}catch(e){console.error("Error fetching data:",e),W("Failed to load vessels data")}finally{B(!1)}})()},[g]),n.useEffect(()=>{(async()=>{if(x==="weekly")try{if(R(!0),O(null),y.length===0){const t=await U();V(t)}const e=await le();X(e)}catch(e){console.error("Error fetching weekly reports:",e),O("Failed to load weekly reports")}finally{R(!1)}})()},[x,y.length]);const N=n.useMemo(()=>v.filter(s=>{if(!m&&!p)return!0;const e=s.arrivalDateTime;if(!e)return!1;let t;if(typeof e=="string")t=new Date(e);else if(e instanceof Date)t=e;else if(e&&typeof e=="object"&&"seconds"in e)t=new Date(e.seconds*1e3);else return!1;if(isNaN(t.getTime()))return!1;const o=m?new Date(m):null,l=p?new Date(p):null;return!(o&&(o.setHours(0,0,0,0),t<o)||l&&(l.setHours(23,59,59,999),t>l))}),[v,m,p]);function Y(s){const e={Container:0,"Break Bulk":0,Project:0,"Liquid Bulk":0,"Dry Bulk":0};for(const t of s)if(t.clearanceIssued)for(const o of t.dailyData||[]){const l=o.cargoType,D=parseFloat(o.totalQuantity);!isNaN(D)&&e.hasOwnProperty(l)&&(e[l]+=D)}return e}const d=n.useMemo(()=>F.filter(s=>{if(C!=="all"&&s.portId!==C)return!1;if(!b&&!j)return!0;const e=s.createdAt||s.created_at,t=e&&e.seconds?new Date(e.seconds*1e3):null;if(!t)return!0;const o=b?new Date(b):null,l=j?new Date(j):null;return o&&l?(l.setHours(23,59,59,999),t>=o&&t<=l):o?t>=o:l?(l.setHours(23,59,59,999),t<=l):!0}),[F,C,b,j]);n.useMemo(()=>{const s=new Date,e=new Date(s);e.setDate(s.getDate()-7),e.setHours(0,0,0,0);const t=new Date(s);t.setHours(23,59,59,999);const o=a=>{const u=a.createdAt||a.created_at;if(!u||!u.seconds)return!1;const $=new Date(u.seconds*1e3);return $>=e&&$<=t},l=d.filter(o).length,D=d.filter(a=>a.berthedDate).length,w=d.filter(a=>a.departureDate).length,h=D-w,i=d.filter(a=>{var u;return((u=a.purposeOfArrival)==null?void 0:u.toLowerCase())==="loading"&&!!a.clearanceIssued}).length,c=d.filter(a=>{var u;return((u=a.purposeOfArrival)==null?void 0:u.toLowerCase())==="unloading"&&!!a.clearanceIssued}).length,f=d.filter(a=>!!a.departureDate&&o(a)).length,k=d.reduce((a,u)=>a+(Number(u.demurragesCollected)||0),0),se=d.reduce((a,u)=>a+(Number(u.totalQuantity)||0),0),{Container:H=0,"Break Bulk":M=0,Project:I=0,"Liquid Bulk":q=0,"Dry Bulk":G=0}=Y(d),ae=d.filter(a=>!!a.clearanceIssued).length,oe=d.filter(a=>!!a.clearanceIssued).length;return[{description:"Total number of vessels called in the last week",total:l},{description:"Total number of vessels in the port as on date",total:h},{description:"Total number of vessels loading in the port as on date",total:i},{description:"Total number of vessels Unloading in the port as on date",total:c},{description:"Total vessels departed last week",total:f},{description:"Demurrages collected (if any) from the ships by the port",total:k},{description:"Total cargo handled since the start of the financial year",total:se},{description:"Cargo handled in the last week",total:M+G+H+I+q},{description:"Bulk cargo",total:G},{description:"Break Bulk",total:M},{description:"Container (in TEU & MMT)",total:H},{description:"Project cargo",total:I},{description:"Liquid cargo",total:q},{description:"Total number of vessels applied for clearance",total:ae},{description:"Total number of clearances issued",total:oe}]},[d]);const Z=s=>{var w;const e=new Date,t=new Date(e.getTime()-7*24*60*60*1e3),l=(s==="all"?v:v.filter(h=>h.portId===s)).filter(h=>{const i=h.arrivalDateTime;if(!i)return!1;let c;if(typeof i=="string")c=new Date(i);else if(i instanceof Date)c=i;else if(i&&typeof i=="object"&&"seconds"in i)c=new Date(i.seconds*1e3);else return!1;return c>=t&&c<=e}),D=s!=="all"?((w=y.find(h=>h.id===s))==null?void 0:w.portName)||"Selected Port":"All Ports";_(l,D,"weekly",void 0,void 0,s==="all")},ee=(s,e,t)=>{var i;const o=new Date(s);o.setHours(0,0,0,0);const l=new Date(e);l.setHours(23,59,59,999);const w=(t==="all"?v:v.filter(c=>c.portId===t)).filter(c=>{const f=c.arrivalDateTime;if(!f)return!1;let k;if(typeof f=="string")k=new Date(f);else if(f instanceof Date)k=f;else if(f&&typeof f=="object"&&"seconds"in f)k=new Date(f.seconds*1e3);else return!1;return k>=o&&k<=l}),h=t!=="all"?((i=y.find(c=>c.id===t))==null?void 0:i.portName)||"Selected Port":"All Ports";_(w,h,"custom",s,e,t==="all")},te=()=>{var s;return P?r.jsx(ne,{message:"Loading vessels data..."}):S?r.jsx(fe,{message:S}):r.jsxs(r.Fragment,{children:[r.jsx(pe,{onGenerateWeekly:Z,onGenerateCustom:ee,ports:y,selectedPortId:g,onPortChange:T,isAdmin:!0}),r.jsxs(ie,{title:"Filters",icon:r.jsx(De,{className:"h-6 w-6 text-seagreen-600"}),className:"mb-6",children:[r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Select Port"}),r.jsxs("select",{value:g,onChange:e=>T(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-seagreen-500",children:[r.jsx("option",{value:"all",children:"All Ports"}),y.map(e=>r.jsx("option",{value:e.id,children:e.portName},e.id))]})]}),r.jsx("div",{className:"md:col-span-2",children:r.jsx(ue,{fromDate:m,toDate:p,onFromDateChange:E,onToDateChange:A,fromLabel:"From Arrival Date",toLabel:"To Arrival Date"})})]}),(m||p||g!=="all")&&r.jsxs("div",{className:"mt-4 flex items-center justify-between bg-seagreen-50 p-3 rounded-lg",children:[r.jsxs("p",{className:"text-sm text-seagreen-700",children:["Showing ",N.length," vessel",N.length!==1?"s":"",g!=="all"&&` from ${(s=y.find(e=>e.id===g))==null?void 0:s.portName}`,m&&p?` between ${new Date(m).toLocaleDateString()} and ${new Date(p).toLocaleDateString()}`:m?` from ${new Date(m).toLocaleDateString()}`:p?` until ${new Date(p).toLocaleDateString()}`:""]}),r.jsx("button",{onClick:()=>{E(""),A(""),T("all")},className:"text-sm text-seagreen-600 hover:text-seagreen-800 font-medium",children:"Clear Filters"})]})]}),r.jsx(de,{vessels:N,loading:P,error:S,showExport:!0})]})};return r.jsxs(ce,{title:x==="vessels"?"Vessels":"Weekly Reports",subtitle:x==="vessels"?"View and manage all vessels across ports":"Weekly vessel performance reports",icon:r.jsx(ge,{className:"h-6 w-6 text-seagreen-600"}),children:[te(),r.jsx(me,{report:z,isOpen:J,onClose:()=>K(!1)})]})};export{Oe as default};
//# sourceMappingURL=VesselsPage-C6CahtIf.js.map
